<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>BTCT Town</title>
  <link rel="stylesheet" href="town-style.css?v=20260225a">
</head>
<body>
  <!-- Top Bar -->
  <div id="top-bar">
    <div class="top-left">
      <a href="/" class="back-link">â† DEX</a>
      <span class="town-title">BTCT Town</span>
    </div>
    <div class="top-center">
      <span id="wallet-display">No Wallet</span>
    </div>
    <div class="top-right">
      <button id="mine-open-btn" onclick="openMinePanel()" title="Mining">â›ï¸</button>
      <button id="char-open-btn" onclick="openCharModal()" title="Customize Character">ğŸ¨</button>
      <span id="player-count">0 online</span>
    </div>
  </div>

  <!-- Game Container -->
  <div id="game-container"></div>

  <!-- Interaction Panel (appears when near NPC/player) -->
  <div id="interaction-panel" class="panel hidden">
    <div class="panel-header">
      <span id="panel-title">Bulletin Board</span>
      <button id="panel-close" onclick="closePanel()">âœ•</button>
    </div>
    <div id="panel-content"></div>
  </div>

  <!-- Trade Modal -->
  <div id="trade-modal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="modal-header">
        <span id="modal-title">Trade</span>
        <button onclick="closeModal()">âœ•</button>
      </div>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Town Wallet Modal -->
  <div id="town-wallet-modal" class="modal-overlay hidden">
    <div class="modal-box" style="max-width:480px;width:96%;max-height:88vh;overflow-y:auto;">
      <div class="modal-header">
        <span>ğŸ‘› Wallet</span>
        <button onclick="closeTownWallet()">âœ•</button>
      </div>
      <div id="town-wallet-content">
        <!-- BTCT Section -->
        <div class="tw-section">
          <div class="tw-coin-header">
            <span class="tw-coin-name">âš¡ BTCT</span>
            <span class="tw-balance" id="tw-btct-bal">Loadingâ€¦</span>
          </div>
          <div id="tw-btct-switch" class="tw-switch hidden"></div>
          <div class="tw-addr" id="tw-btct-addr">--</div>
          <div class="tw-send" id="tw-btct-send-box">
            <div class="tw-send-title">Send BTCT</div>
            <input type="text" id="tw-btct-to" placeholder="Recipient 0x..." autocomplete="off">
            <input type="number" id="tw-btct-amount" placeholder="Amount (BTCT)" step="0.00001" min="0">
            <div class="tw-fee">Network fee: 0.00001 BTCT</div>
            <div id="tw-btct-msg" class="tw-msg hidden"></div>
            <button class="btn btn-primary tw-send-btn" onclick="townWalletSendBtct()">Send BTCT</button>
          </div>
          <div id="tw-btct-nokey" class="tw-nokey hidden">âš  No private key â€” view only.</div>
          <div class="tw-actions">
            <button class="btn btn-sm tw-act-btn" onclick="townGenBtct()">+ New</button>
            <button class="btn btn-sm tw-act-btn" onclick="townToggleImportBtct()">Import</button>
            <button class="btn btn-sm tw-act-btn" id="tw-btct-export-btn" onclick="townExportBtct()">Export Key</button>
          </div>
          <div id="tw-btct-import" class="tw-import-box hidden">
            <input type="password" id="tw-btct-import-key" placeholder="64-char hex private key" autocomplete="off">
            <button class="btn btn-primary btn-sm" onclick="townImportBtct()">Import</button>
          </div>
          <div id="tw-btct-backup" class="tw-backup hidden"></div>
          <div id="tw-btct-gen-msg" class="tw-msg hidden"></div>
        </div>

        <div class="tw-divider"></div>

        <!-- DOGE Section -->
        <div class="tw-section">
          <div class="tw-coin-header">
            <span class="tw-coin-name">ğŸ• DOGE</span>
            <span class="tw-balance" id="tw-doge-bal">Loadingâ€¦</span>
          </div>
          <div id="tw-doge-switch" class="tw-switch hidden"></div>
          <div class="tw-addr" id="tw-doge-addr">--</div>
          <div class="tw-send" id="tw-doge-send-box">
            <div class="tw-send-title">Send DOGE</div>
            <input type="text" id="tw-doge-to" placeholder="Recipient D..." autocomplete="off">
            <input type="number" id="tw-doge-amount" placeholder="Amount (DOGE)" step="0.01" min="0">
            <div class="tw-fee">Network fee: ~0.02 DOGE</div>
            <div id="tw-doge-msg" class="tw-msg hidden"></div>
            <button class="btn btn-primary tw-send-btn" onclick="townWalletSendDoge()">Send DOGE</button>
          </div>
          <div id="tw-doge-nokey" class="tw-nokey hidden">âš  No DOGE key â€” view only.</div>
          <div id="tw-doge-none" class="tw-nokey hidden">âš  No DOGE wallet.</div>
          <div class="tw-actions">
            <button class="btn btn-sm tw-act-btn" onclick="townGenDoge()">+ New</button>
            <button class="btn btn-sm tw-act-btn" onclick="townToggleImportDoge()">Import WIF</button>
            <button class="btn btn-sm tw-act-btn" id="tw-doge-export-btn" onclick="townExportDoge()">Export Key</button>
          </div>
          <div id="tw-doge-import" class="tw-import-box hidden">
            <input type="password" id="tw-doge-import-wif" placeholder="DOGE WIF private key (Q...)" autocomplete="off">
            <button class="btn btn-primary btn-sm" onclick="townImportDoge()">Import</button>
          </div>
          <div id="tw-doge-backup" class="tw-backup hidden"></div>
          <div id="tw-doge-gen-msg" class="tw-msg hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Character Customizer Modal -->
  <div id="char-modal" class="modal-overlay hidden">
    <div class="modal-box" style="max-width:420px;width:96%;">
      <div class="modal-header">
        <span>ğŸ¨ Character</span>
        <button onclick="closeCharModal()">âœ•</button>
      </div>
      <div id="char-modal-content">
        <!-- Preview -->
        <div class="char-preview-wrap">
          <canvas id="char-preview-canvas" width="24" height="32"></canvas>
        </div>
        <!-- Type -->
        <div class="char-section">
          <div class="char-label">Type</div>
          <div class="char-opts" id="char-type-opts">
            <button class="char-opt" data-prop="type" data-val="0" onclick="setCharOpt('type',0)">ğŸ§‘ Default</button>
            <button class="char-opt" data-prop="type" data-val="1" onclick="setCharOpt('type',1)">âš”ï¸ Warrior</button>
            <button class="char-opt" data-prop="type" data-val="2" onclick="setCharOpt('type',2)">ğŸ”® Mage</button>
            <button class="char-opt" data-prop="type" data-val="3" onclick="setCharOpt('type',3)">ğŸ—¡ï¸ Rogue</button>
          </div>
        </div>
        <!-- Skin -->
        <div class="char-section">
          <div class="char-label">Skin</div>
          <div class="char-colors" id="char-skin-opts">
            <button class="char-color" data-prop="skin" data-val="0" style="background:#f0c987" onclick="setCharOpt('skin',0)" title="Light Warm"></button>
            <button class="char-color" data-prop="skin" data-val="1" style="background:#fad5c0" onclick="setCharOpt('skin',1)" title="Pale"></button>
            <button class="char-color" data-prop="skin" data-val="2" style="background:#c4885a" onclick="setCharOpt('skin',2)" title="Medium Brown"></button>
            <button class="char-color" data-prop="skin" data-val="3" style="background:#8b5e3c" onclick="setCharOpt('skin',3)" title="Brown"></button>
            <button class="char-color" data-prop="skin" data-val="4" style="background:#5c3d1e" onclick="setCharOpt('skin',4)" title="Dark"></button>
            <button class="char-color" data-prop="skin" data-val="5" style="background:#e8b89a" onclick="setCharOpt('skin',5)" title="Peach"></button>
          </div>
        </div>
        <!-- Cloth -->
        <div class="char-section">
          <div class="char-label">Outfit</div>
          <div class="char-colors" id="char-cloth-opts">
            <button class="char-color" data-prop="cloth" data-val="0" style="background:#3498db" onclick="setCharOpt('cloth',0)" title="Blue"></button>
            <button class="char-color" data-prop="cloth" data-val="1" style="background:#c0392b" onclick="setCharOpt('cloth',1)" title="Red"></button>
            <button class="char-color" data-prop="cloth" data-val="2" style="background:#27ae60" onclick="setCharOpt('cloth',2)" title="Green"></button>
            <button class="char-color" data-prop="cloth" data-val="3" style="background:#8e44ad" onclick="setCharOpt('cloth',3)" title="Purple"></button>
            <button class="char-color" data-prop="cloth" data-val="4" style="background:#e67e22" onclick="setCharOpt('cloth',4)" title="Orange"></button>
            <button class="char-color" data-prop="cloth" data-val="5" style="background:#7f8c8d" onclick="setCharOpt('cloth',5)" title="Gray"></button>
          </div>
        </div>
        <!-- Hair -->
        <div class="char-section">
          <div class="char-label">Hair</div>
          <div class="char-colors" id="char-hair-opts">
            <button class="char-color" data-prop="hair" data-val="0" style="background:#5a3620" onclick="setCharOpt('hair',0)" title="Brown"></button>
            <button class="char-color" data-prop="hair" data-val="1" style="background:#1a1a1a" onclick="setCharOpt('hair',1)" title="Black"></button>
            <button class="char-color" data-prop="hair" data-val="2" style="background:#f6c90e" onclick="setCharOpt('hair',2)" title="Blonde"></button>
            <button class="char-color" data-prop="hair" data-val="3" style="background:#c0392b" onclick="setCharOpt('hair',3)" title="Red"></button>
            <button class="char-color" data-prop="hair" data-val="4" style="background:#bdc3c7" onclick="setCharOpt('hair',4)" title="Silver"></button>
          </div>
        </div>
        <!-- Hat -->
        <div class="char-section">
          <div class="char-label">Hat</div>
          <div class="char-opts" id="char-hat-opts">
            <button class="char-opt" data-prop="hat" data-val="0" onclick="setCharOpt('hat',0)">â€” None</button>
            <button class="char-opt" data-prop="hat" data-val="1" onclick="setCharOpt('hat',1)">ğŸ§¢ Cap</button>
            <button class="char-opt" data-prop="hat" data-val="2" onclick="setCharOpt('hat',2)">ğŸ© Wizard</button>
            <button class="char-opt" data-prop="hat" data-val="3" onclick="setCharOpt('hat',3)">ğŸ”´ Bandana</button>
            <button class="char-opt" data-prop="hat" data-val="4" onclick="setCharOpt('hat',4)">ğŸ‘‘ Crown</button>
          </div>
        </div>
        <!-- Glasses -->
        <div class="char-section">
          <div class="char-label">Glasses</div>
          <div class="char-opts" id="char-glasses-opts">
            <button class="char-opt" data-prop="glasses" data-val="0" onclick="setCharOpt('glasses',0)">â€” None</button>
            <button class="char-opt" data-prop="glasses" data-val="1" onclick="setCharOpt('glasses',1)">ğŸ‘“ Glasses</button>
            <button class="char-opt" data-prop="glasses" data-val="2" onclick="setCharOpt('glasses',2)">ğŸ•¶ï¸ Shades</button>
          </div>
        </div>
        <div style="text-align:center;margin-top:14px;">
          <button class="btn btn-primary" onclick="saveCharacter()">ğŸ’¾ Apply &amp; Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Town Disclaimer Modal -->
  <div class="disclaimer-modal" id="townDisclaimerModal">
    <div class="disclaimer-modal-content">
      <h2>âš ï¸ BTCT Town â€” Important Notice</h2>
      <div class="disclaimer-text">
        <p><strong>BTCT Town is a visual interface for the BTCT/DOGE DEX.</strong></p>
        <ul>
          <li>UI layer only. All trades execute via HTLC atomic swaps on-chain.</li>
          <li>Server never holds, accesses, or stores private keys.</li>
          <li>All transaction signing happens in your browser only.</li>
          <li>Chat messages are stored for dispute reference, auto-deleted after 90 days.</li>
          <li>Only BTCT addresses and chat messages are collected. No personal info.</li>
          <li>Platform operators bear no responsibility for trade outcomes.</li>
          <li>Users are solely responsible for complying with applicable laws.</li>
        </ul>
        <p class="warning-text">âš  If a swap times out, both BTCT and DOGE in HTLC contracts are refundable. Understand how atomic swaps work before trading.</p>
        <p style="font-size:12px;margin-top:8px;"><a href="/privacy" target="_blank" style="color:#4ecca3;">Privacy Policy</a></p>
      </div>
      <label class="disclaimer-checkbox">
        <input type="checkbox" id="townDisclaimerCheck" onchange="toggleTownDisclaimer()">
        <span>I have read and understood the above. I use BTCT Town at my own risk.</span>
      </label>
      <button class="btn btn-primary disclaimer-enter-btn" id="townDisclaimerEnterBtn" disabled onclick="acceptTownDisclaimer()">Enter BTCT Town</button>
    </div>
  </div>

  <!-- Market Price Panel (top-right overlay) -->
  <div id="market-panel">
    <div class="market-panel-header" onclick="toggleMarketPanel()">
      <span>âš¡ Market</span>
      <span id="market-panel-toggle-icon">âˆ’</span>
    </div>
    <div class="market-panel-body" id="market-panel-body">
      <div class="mp-section">
        <div class="mp-coin">ğŸ• DOGE / USDT</div>
        <div class="mp-price" id="mp-doge-price">--</div>
        <div class="mp-change" id="mp-doge-change">--</div>
      </div>
      <div class="mp-divider"></div>
      <div class="mp-section">
        <div class="mp-coin">âš¡ BTCT / DOGE</div>
        <div class="mp-price" id="mp-btct-price">--</div>
        <div class="mp-usd" id="mp-btct-usd">â‰ˆ $--</div>
        <div class="mp-change" id="mp-btct-change">--</div>
        <div class="mp-row"><span class="mp-label">24h High</span><span id="mp-btct-high">--</span></div>
        <div class="mp-row"><span class="mp-label">24h Low</span><span id="mp-btct-low">--</span></div>
      </div>
      <div class="mp-footer">30s auto-refresh</div>
    </div>
  </div>

  <!-- Town Global Chat -->
  <div id="town-chat">
    <div id="town-chat-messages"></div>
    <div id="emoji-bar" class="hidden">
      <button onclick="sendTownEmoji('ğŸ˜€')">ğŸ˜€</button>
      <button onclick="sendTownEmoji('ğŸ˜‚')">ğŸ˜‚</button>
      <button onclick="sendTownEmoji('ğŸ˜')">ğŸ˜</button>
      <button onclick="sendTownEmoji('ğŸ˜')">ğŸ˜</button>
      <button onclick="sendTownEmoji('ğŸ¤”')">ğŸ¤”</button>
      <button onclick="sendTownEmoji('ğŸ˜±')">ğŸ˜±</button>
      <button onclick="sendTownEmoji('ğŸ˜­')">ğŸ˜­</button>
      <button onclick="sendTownEmoji('ğŸ¤©')">ğŸ¤©</button>
      <button onclick="sendTownEmoji('ğŸ¥³')">ğŸ¥³</button>
      <button onclick="sendTownEmoji('ğŸ˜¤')">ğŸ˜¤</button>
      <button onclick="sendTownEmoji('ğŸ‘')">ğŸ‘</button>
      <button onclick="sendTownEmoji('ğŸ‘')">ğŸ‘</button>
      <button onclick="sendTownEmoji('ğŸ‘‹')">ğŸ‘‹</button>
      <button onclick="sendTownEmoji('ğŸ™')">ğŸ™</button>
      <button onclick="sendTownEmoji('ğŸ’ª')">ğŸ’ª</button>
      <button onclick="sendTownEmoji('ğŸ¤')">ğŸ¤</button>
      <button onclick="sendTownEmoji('ğŸ‰')">ğŸ‰</button>
      <button onclick="sendTownEmoji('ğŸ”¥')">ğŸ”¥</button>
      <button onclick="sendTownEmoji('ğŸ’°')">ğŸ’°</button>
      <button onclick="sendTownEmoji('ğŸ’')">ğŸ’</button>
      <button onclick="sendTownEmoji('ğŸš€')">ğŸš€</button>
      <button onclick="sendTownEmoji('âš¡')">âš¡</button>
      <button onclick="sendTownEmoji('ğŸ•')">ğŸ•</button>
      <button onclick="sendTownEmoji('ğŸ“ˆ')">ğŸ“ˆ</button>
      <button onclick="sendTownEmoji('ğŸ“‰')">ğŸ“‰</button>
      <button onclick="sendTownEmoji('â‚¿')" style="color:#f5c542;">â‚¿</button>
      <button onclick="sendTownEmoji('âœ…')">âœ…</button>
      <button onclick="sendTownEmoji('âŒ')">âŒ</button>
      <button onclick="sendTownEmoji('â³')">â³</button>
      <button onclick="sendTownEmoji('â¤ï¸')">â¤ï¸</button>
    </div>
    <div id="town-chat-input-row">
      <input type="text" id="town-chat-input" placeholder="Press Enter to chat..." maxlength="200" autocomplete="off">
      <button id="emoji-toggle-btn" onclick="toggleEmojiBar()" title="Emojis">ğŸ˜€</button>
    </div>
  </div>

  <!-- Mining Panel Modal -->
  <div id="mine-modal" class="modal-overlay hidden">
    <div class="modal-box" style="max-width:420px;width:94%;">
      <div class="modal-header">
        <span>â›ï¸ Mining</span>
        <button onclick="closeMinePanel()">âœ•</button>
      </div>
      <div id="mine-content" style="padding:12px 16px;">
        <div id="mine-status-section">
          <div class="mine-row">
            <span class="mine-label">Status</span>
            <span id="mine-status" class="mine-val">Stopped</span>
          </div>
          <div class="mine-row">
            <span class="mine-label">Network</span>
            <span id="mine-consensus" class="mine-val">â€”</span>
          </div>
          <div class="mine-row">
            <span class="mine-label">Block</span>
            <span id="mine-block" class="mine-val">â€”</span>
          </div>
          <div class="mine-row">
            <span class="mine-label">Pool</span>
            <span class="mine-val" style="color:#888;">pool.btc-time.com</span>
          </div>
        </div>
        <div style="border-top:1px solid #1e3a5f;margin:10px 0;"></div>
        <div class="mine-row">
          <span class="mine-label">Address</span>
          <span id="mine-address" class="mine-val" style="font-size:11px;word-break:break-all;">â€”</span>
        </div>
        <div style="border-top:1px solid #1e3a5f;margin:10px 0;"></div>
        <div class="mine-row">
          <span class="mine-label">Hashrate</span>
          <span id="mine-hashrate" class="mine-val" style="color:#00d4ff;font-weight:bold;">0 H/s</span>
        </div>
        <div class="mine-row" style="align-items:center;">
          <span class="mine-label">Threads</span>
          <div style="display:flex;align-items:center;gap:8px;">
            <input type="range" id="mine-threads" min="1" max="4" value="1"
              style="width:120px;accent-color:#00d4ff;" oninput="onMineThreadChange(this.value)">
            <span id="mine-thread-val" style="color:#f0f0f0;min-width:30px;">1</span>
          </div>
        </div>
        <div style="border-top:1px solid #1e3a5f;margin:10px 0;"></div>
        <div class="mine-row">
          <span class="mine-label">Pool Balance</span>
          <span id="mine-balance" class="mine-val">0 BTCT</span>
        </div>
        <div class="mine-row">
          <span class="mine-label">Confirmed</span>
          <span id="mine-confirmed" class="mine-val" style="color:#4ecca3;">0 BTCT</span>
        </div>
        <div style="margin-top:14px;">
          <button id="mine-start-btn" onclick="toggleMining()" class="mine-btn mine-btn-start">â–¶ Start Mining</button>
        </div>
        <div id="mine-error" style="color:#ff6b6b;font-size:11px;margin-top:8px;display:none;"></div>
      </div>
    </div>
  </div>

  <!-- Mobile Controls (hidden by default, shown on touch devices) -->
  <div id="mobile-controls">
    <div id="joystick-base">
      <div id="joystick-stick"></div>
    </div>
    <div id="mobile-action-btn">ACT</div>
  </div>

  <!-- Controls Help -->
  <div id="controls-help">
    <span>Arrow Keys / WASD to move</span>
    <span>SPACE near NPC to interact</span>
    <span>ENTER to chat</span>
    <span><a href="/privacy" target="_blank" style="color:#666;">Privacy Policy</a></span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="web.js"></script>
  <script src="bitcore-doge.js?v=20260220i"></script>
  <script src="doge-htlc.js?v=20260220i"></script>
  <script src="town-mine.js?v=20260224a"></script>
  <script src="town.js?v=20260225a"></script>
</body>
</html>
